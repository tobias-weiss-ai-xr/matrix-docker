services:
  # Synapse - Matrix Homeserver
  synapse:
    image: matrixdotorg/synapse:latest
    restart: unless-stopped
    container_name: matrix-synapse
    network_mode: host
    user: "0:0"
    entrypoint:
      - "/bin/sh"
      - "-c"
      - "chown -R 988:988 /data && exec /start.py"
    environment:
      - SYNAPSE_CONFIG_PATH=/config/homeserver.yaml
      - SYNAPSE_SERVER_NAME=graphwiz.ai
      - SYNAPSE_REPORT_STATS=no
      - UID=988
      - GID=988
    volumes:
      - synapse_data:/data
      - ./homeserver.yaml:/config/homeserver.yaml:ro
    depends_on:
      - synapse_db
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.matrix-synapse.rule=Host(`matrix.graphwiz.ai`)"
      - "traefik.http.routers.matrix-synapse.entrypoints=websecure"
      - "traefik.http.routers.matrix-synapse.tls=true"
      - "traefik.http.routers.matrix-synapse.tls.certresolver=mytlschallenge"
      - "traefik.http.routers.matrix-synapse.service=matrix-synapse"
      - "traefik.http.services.matrix-synapse.loadbalancer.server.port=8008"

  # Synapse Database
  synapse_db:
    image: postgres:17.5
    restart: unless-stopped
    container_name: matrix-synapse-db
    network_mode: host
    environment:
      - POSTGRES_USER=synapse
      - POSTGRES_PASSWORD=mVVzYVCKgptv1Az8hYfY2cbNYBBo/EsL+k5HHH247uc=
      - POSTGRES_DB=synapse
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    command:
      - "postgres"
      - "-c"
      - "port=5433"
    volumes:
      - synapse_db_data:/var/lib/postgresql/data

  # Coturn - TURN/STUN server for VoIP/video calls
  coturn:
    image: instrumentisto/coturn:latest
    restart: unless-stopped
    container_name: matrix-coturn
    network_mode: host
    environment:
      - TURN_PORT=3478
      - TURNS_PORT=5349
    volumes:
      - coturn_data:/var/lib/coturn

  # Matrix Federation (delegation)
  matrix-well-known:
    image: nginx:alpine
    restart: unless-stopped
    container_name: matrix-well-known
    network_mode: host
    volumes:
      - ./well-known-8083.conf:/etc/nginx/conf.d/default.conf:ro
    command:
      - "sh"
      - "-c"
      - "nginx -g 'daemon off;' -c /etc/nginx/nginx.conf"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.matrix-well-known.rule=Host(`graphwiz.ai`) && (PathPrefix(`/.well-known/matrix/server`) || PathPrefix(`/.well-known/matrix/client`))"
      - "traefik.http.routers.matrix-well-known.entrypoints=websecure"
      - "traefik.http.routers.matrix-well-known.tls=true"
      - "traefik.http.routers.matrix-well-known.service=matrix-well-known"
      - "traefik.http.services.matrix-well-known.loadbalancer.server.port=8083"
      - "traefik.http.routers.matrix-well-known.priority=100"

volumes:
  synapse_data:
    driver: local
  synapse_db_data:
    driver: local
  coturn_data:
    driver: local
